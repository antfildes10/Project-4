{% extends "admin/base_site.html" %}

{% load static i18n %}

{% block content %}
  <div id="content-main">
    <!-- Quick Stats Overview -->
    <div class="module dashboard-stats">
      <h2>
        Today's Overview - {{ today|date:"l, F j, Y" }}
      </h2>
      <div class="stats-grid">
        <div class="stat-card stat-success">
          <h3 class="stat-label">
            Today's Sessions
          </h3>
          <p class="stat-value">
            {{ stats.todays_sessions }}
          </p>
        </div>
        <div class="stat-card stat-warning">
          <h3 class="stat-label">
            Pending Bookings
          </h3>
          <p class="stat-value">
            {{ stats.pending_bookings }}
          </p>
        </div>
        <div class="stat-card stat-primary">
          <h3 class="stat-label">
            Confirmed Bookings
          </h3>
          <p class="stat-value">
            {{ stats.confirmed_bookings }}
          </p>
        </div>
        <div class="stat-card stat-info">
          <h3 class="stat-label">
            Active Karts
          </h3>
          <p class="stat-value">
            {{ stats.active_karts }} / {{ stats.total_karts }}
          </p>
        </div>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="dashboard-two-col">

      <!-- Today's Sessions -->
      <div class="module">
        <h2>
          Today's Sessions
        </h2>
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>
                Time
              </th>
              <th>
                Type
              </th>
              <th>
                Capacity
              </th>
              <th>
                Status
              </th>
            </tr>
          </thead>
          <tbody>
            {% for session in todays_sessions %}
              <tr>
                <td>
                  {{ session.start_datetime|date:"H:i" }} - {{ session.end_datetime|date:"H:i" }}
                </td>
                <td>
                  {{ session.get_session_type_display }}
                </td>
                <td>
                  {{ session.bookings.count }} / {{ session.capacity }}
                </td>
                <td>
                  {% now "U" as current_timestamp %}
                  {% if session.end_datetime.timestamp < current_timestamp|add:"0" %}
                    <span class="badge-secondary">Completed</span>
                  {% elif session.start_datetime.timestamp <= current_timestamp|add:"0" and session.end_datetime.timestamp > current_timestamp|add:"0" %}
                    <span class="badge-warning">In Progress</span>
                  {% elif session.is_full %}
                    <span class="badge-danger">FULL</span>
                  {% else %}
                    <span class="badge-success">{{ session.get_available_spots }} spots</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="empty-state">
                  No sessions scheduled for today
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if todays_sessions %}
          <div class="module-footer">
            <a href="{% url 'admin:session_slots_sessionslot_changelist' %}?start_datetime__day={{ today.day }}&start_datetime__month={{ today.month }}&start_datetime__year={{ today.year }}"
               class="footer-link">View all today's sessions →</a>
          </div>
        {% endif %}
      </div>

      <!-- Pending Bookings -->
      <div class="module">
        <h2>
          Pending Bookings - Action Required
        </h2>
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>
                Driver
              </th>
              <th>
                Session
              </th>
              <th>
                Created
              </th>
              <th>
                Action
              </th>
            </tr>
          </thead>
          <tbody>
            {% for booking in pending_bookings %}
              <tr>
                <td>
                  {{ booking.driver.username }}
                </td>
                <td>
                  {{ booking.session_slot.start_datetime|date:"M j, H:i" }}
                </td>
                <td>
                  {{ booking.created_at|timesince }} ago
                </td>
                <td>
                  <a href="{% url 'admin:bookings_booking_change' booking.pk %}"
                     class="action-link">Review</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="empty-state empty-success">
                  ✓ No pending bookings
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if pending_bookings %}
          <div class="module-footer">
            <a href="{% url 'admin:bookings_booking_changelist' %}?status__exact=PENDING"
               class="footer-link">View all pending bookings →</a>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Upcoming Sessions -->
    <div class="module">
      <h2>
        Upcoming Sessions (Next 7 Days)
      </h2>
      <div class="table-responsive">
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>
                Date & Time
              </th>
              <th>
                Type
              </th>
              <th>
                Track
              </th>
              <th>
                Bookings
              </th>
              <th>
                Available
              </th>
              <th>
                Status
              </th>
              <th>
                Actions
              </th>
            </tr>
          </thead>
          <tbody>
            {% for session in upcoming_sessions %}
              <tr>
                <td>
                  {{ session.start_datetime|date:"D, M j - H:i" }}
                </td>
                <td>
                  {% if session.session_type == 'GRAND_PRIX' %}
                    <span class="badge badge-warning">GP</span>
                  {% else %}
                    <span class="badge badge-info">OPEN</span>
                  {% endif %}
                </td>
                <td>
                  {{ session.track.name }}
                </td>
                <td>
                  {{ session.bookings.count }}
                </td>
                <td>
                  {{ session.get_available_spots }}
                </td>
                <td>
                  {% if session.is_full %}
                    <span class="badge-danger">FULL</span>
                  {% else %}
                    <span class="badge-success">Available</span>
                  {% endif %}
                </td>
                <td>
                  <a href="{% url 'admin:session_slots_sessionslot_change' session.pk %}"
                     class="action-link">Edit</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="empty-state">
                  No upcoming sessions in the next 7 days
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% if upcoming_sessions %}
        <div class="module-footer">
          <a href="{% url 'admin:session_slots_sessionslot_changelist' %}"
             class="footer-link">View all sessions →</a>
        </div>
      {% endif %}
    </div>

    <!-- Kart Status -->
    <div class="module">
      <h2>
        Kart Fleet Status
      </h2>
      <div class="table-responsive">
        <table class="dashboard-table">
          <thead>
            <tr>
              <th>
                Kart #
              </th>
              <th>
                Status
              </th>
              <th>
                Upcoming Bookings
              </th>
              <th>
                Last Updated
              </th>
              <th>
                Actions
              </th>
            </tr>
          </thead>
          <tbody>
            {% for kart in karts %}
              <tr>
                <td>
                  <strong>Kart #{{ kart.number }}</strong>
                </td>
                <td>
                  {% if kart.status == 'ACTIVE' %}
                    <span class="badge badge-success">ACTIVE</span>
                  {% else %}
                    <span class="badge badge-warning">MAINTENANCE</span>
                  {% endif %}
                </td>
                <td>
                  {{ kart.upcoming_count }}
                </td>
                <td>
                  {{ kart.updated_at|date:"M j, H:i" }}
                </td>
                <td>
                  <a href="{% url 'admin:karts_kart_change' kart.pk %}"
                     class="action-link">Edit</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="module-footer">
        <a href="{% url 'admin:karts_kart_changelist' %}" class="footer-link">Manage all karts →</a>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="module quick-actions-module">
      <h2>
        Quick Actions
      </h2>
      <div class="quick-actions-grid">
        <a href="{% url 'admin:session_slots_sessionslot_add' %}"
           class="button quick-action-btn">
          <i class="fas fa-plus-circle"></i> Create Session
        </a>
        <a href="{% url 'admin:bookings_booking_add' %}"
           class="button quick-action-btn">
          <i class="fas fa-plus-circle"></i> New Booking
        </a>
        <a href="{% url 'admin:karts_kart_add' %}"
           class="button quick-action-btn">
          <i class="fas fa-plus-circle"></i> Add Kart
        </a>
        <a href="{% url 'admin:bookings_booking_changelist' %}?status__exact=PENDING"
           class="button quick-action-btn">
          <i class="fas fa-clipboard-check"></i> Review Pending
        </a>
      </div>
    </div>

    <!-- Original App List -->
    <div class="module">
      <h2>
        All Applications
      </h2>
      {% if app_list %}
        {% for app in app_list %}
          <div class="app-{{ app.app_label }} module">
            <table>
              <caption>
                <a href="{{ app.app_url }}"
                   class="section"
                   title="{% blocktranslate with name=app.name %}
                            Models in the {{ name }} application
                          {% endblocktranslate %}">{{ app.name }}</a>
              </caption>
              {% for model in app.models %}
                <tr class="model-{{ model.object_name|lower }}">
                  {% if model.admin_url %}
                    <th scope="row">
                      <a href="{{ model.admin_url }}"
                         {% if model.add_url %}
                           class="addlink"
                         {% endif %}>{{ model.name }}</a>
                    </th>
                  {% else %}
                    <th scope="row">
                      {{ model.name }}
                    </th>
                  {% endif %}

                  {% if model.add_url %}
                    <td>
                      <a href="{{ model.add_url }}" class="addlink">Add</a>
                    </td>
                  {% else %}
                    <td>
                      &nbsp;
                    </td>
                  {% endif %}

                  {% if model.admin_url %}
                    {% if model.view_only %}
                      <td>
                        <a href="{{ model.admin_url }}" class="viewlink">View</a>
                      </td>
                    {% else %}
                      <td>
                        <a href="{{ model.admin_url }}" class="changelink">Change</a>
                      </td>
                    {% endif %}
                  {% else %}
                    <td>
                      &nbsp;
                    </td>
                  {% endif %}
                </tr>
              {% endfor %}
            </table>
          </div>
        {% endfor %}
      {% else %}
        <p>
          No available applications.
        </p>
      {% endif %}
    </div>
  </div>

{% endblock %}
