{% extends "admin/base_site.html" %}

{% load static i18n %}

{% block content %}
  <div id="content-main">
    <h1>
      KartControl Operations Dashboard
    </h1>

    <!-- Quick Stats Overview -->
    <div class="module dashboard-stats">
      <h2>
        Today's Overview - {{ today|date:"l, F j, Y" }}
      </h2>
      <div class="stats-grid">
        <div class="stat-card stat-success">
          <h3 class="stat-label">
            Today's Sessions
          </h3>
          <p class="stat-value">
            {{ stats.todays_sessions }}
          </p>
        </div>
        <div class="stat-card stat-warning">
          <h3 class="stat-label">
            Pending Bookings
          </h3>
          <p class="stat-value">
            {{ stats.pending_bookings }}
          </p>
        </div>
        <div class="stat-card stat-primary">
          <h3 class="stat-label">
            Confirmed Bookings
          </h3>
          <p class="stat-value">
            {{ stats.confirmed_bookings }}
          </p>
        </div>
        <div class="stat-card stat-info">
          <h3 class="stat-label">
            Active Karts
          </h3>
          <p class="stat-value">
            {{ stats.active_karts }} / {{ stats.total_karts }}
          </p>
        </div>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div style="display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px">

      <!-- Today's Sessions -->
      <div class="module">
        <h2>
          Today's Sessions
        </h2>
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>
                Time
              </th>
              <th>
                Type
              </th>
              <th>
                Capacity
              </th>
              <th>
                Status
              </th>
            </tr>
          </thead>
          <tbody>
            {% for session in todays_sessions %}
              <tr>
                <td>
                  {{ session.start_datetime|date:"H:i" }} - {{ session.end_datetime|date:"H:i" }}
                </td>
                <td>
                  {{ session.get_session_type_display }}
                </td>
                <td>
                  {{ session.bookings.count }} / {{ session.capacity }}
                </td>
                <td>
                  {% if session.is_full %}
                    <span style="color: #dc3545; font-weight: bold;">FULL</span>
                  {% else %}
                    <span style="color: #28a745;">{{ session.get_available_spots }} spots left</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" style="text-align: center; color: #999; padding: 20px;">
                  No sessions scheduled for today
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if todays_sessions %}
          <div style="padding: 10px; text-align: right; border-top: 1px solid #ddd;">
            <a href="{% url 'admin:session_slots_sessionslot_changelist' %}?start_datetime__day={{ today.day }}&start_datetime__month={{ today.month }}&start_datetime__year={{ today.year }}"
               style="color: #447e9b">View all today's sessions →</a>
          </div>
        {% endif %}
      </div>

      <!-- Pending Bookings -->
      <div class="module">
        <h2>
          Pending Bookings - Action Required
        </h2>
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>
                Driver
              </th>
              <th>
                Session
              </th>
              <th>
                Created
              </th>
              <th>
                Action
              </th>
            </tr>
          </thead>
          <tbody>
            {% for booking in pending_bookings %}
              <tr>
                <td>
                  {{ booking.driver.username }}
                </td>
                <td>
                  {{ booking.session_slot.start_datetime|date:"M j, H:i" }}
                </td>
                <td>
                  {{ booking.created_at|timesince }} ago
                </td>
                <td>
                  <a href="{% url 'admin:bookings_booking_change' booking.pk %}"
                     style="color: #447e9b">Review</a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" style="text-align: center; color: #28a745; padding: 20px">
                  ✓ No pending bookings
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if pending_bookings %}
          <div style="padding: 10px; text-align: right; border-top: 1px solid #ddd;">
            <a href="{% url 'admin:bookings_booking_changelist' %}?status__exact=PENDING"
               style="color: #447e9b">View all pending bookings →</a>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Upcoming Sessions -->
    <div class="module" style="margin-bottom: 20px;">
      <h2>
        Upcoming Sessions (Next 7 Days)
      </h2>
      <table style="width: 100%;">
        <thead>
          <tr>
            <th>
              Date & Time
            </th>
            <th>
              Type
            </th>
            <th>
              Track
            </th>
            <th>
              Bookings
            </th>
            <th>
              Available
            </th>
            <th>
              Status
            </th>
            <th>
              Actions
            </th>
          </tr>
        </thead>
        <tbody>
          {% for session in upcoming_sessions %}
            <tr>
              <td>
                {{ session.start_datetime|date:"D, M j - H:i" }}
              </td>
              <td>
                {% if session.session_type == 'GRAND_PRIX' %}
                  <span style="background: #ffc107;
                               color: #000;
                               padding: 2px 8px;
                               border-radius: 3px;
                               font-size: 11px">GP</span>
                {% else %}
                  <span style="background: #17a2b8;
                               color: white;
                               padding: 2px 8px;
                               border-radius: 3px;
                               font-size: 11px">OPEN</span>
                {% endif %}
              </td>
              <td>
                {{ session.track.name }}
              </td>
              <td>
                {{ session.bookings.count }}
              </td>
              <td>
                {{ session.get_available_spots }}
              </td>
              <td>
                {% if session.is_full %}
                  <span style="color: #dc3545; font-weight: bold;">FULL</span>
                {% else %}
                  <span style="color: #28a745;">Available</span>
                {% endif %}
              </td>
              <td>
                <a href="{% url 'admin:session_slots_sessionslot_change' session.pk %}"
                   style="color: #447e9b">Edit</a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" style="text-align: center; color: #999; padding: 20px;">
                No upcoming sessions in the next 7 days
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if upcoming_sessions %}
        <div style="padding: 10px; text-align: right; border-top: 1px solid #ddd;">
          <a href="{% url 'admin:session_slots_sessionslot_changelist' %}"
             style="color: #447e9b">View all sessions →</a>
        </div>
      {% endif %}
    </div>

    <!-- Kart Status -->
    <div class="module" style="margin-bottom: 20px;">
      <h2>
        Kart Fleet Status
      </h2>
      <table style="width: 100%;">
        <thead>
          <tr>
            <th>
              Kart #
            </th>
            <th>
              Status
            </th>
            <th>
              Upcoming Bookings
            </th>
            <th>
              Last Updated
            </th>
            <th>
              Actions
            </th>
          </tr>
        </thead>
        <tbody>
          {% for kart in karts %}
            <tr>
              <td>
                <strong>Kart #{{ kart.number }}</strong>
              </td>
              <td>
                {% if kart.status == 'ACTIVE' %}
                  <span style="background: #28a745;
                               color: white;
                               padding: 2px 8px;
                               border-radius: 3px;
                               font-size: 11px">ACTIVE</span>
                {% else %}
                  <span style="background: #ffc107;
                               color: #000;
                               padding: 2px 8px;
                               border-radius: 3px;
                               font-size: 11px">MAINTENANCE</span>
                {% endif %}
              </td>
              <td>
                {{ kart.upcoming_count }}
              </td>
              <td>
                {{ kart.updated_at|date:"M j, H:i" }}
              </td>
              <td>
                <a href="{% url 'admin:karts_kart_change' kart.pk %}"
                   style="color: #447e9b">Edit</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="padding: 10px; text-align: right; border-top: 1px solid #ddd;">
        <a href="{% url 'admin:karts_kart_changelist' %}" style="color: #447e9b">Manage all karts →</a>
      </div>
    </div>

    <!-- Quick Actions -->
    <div class="module" style="margin-bottom: 20px;">
      <h2>
        Quick Actions
      </h2>
      <div style="display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                  gap: 10px;
                  padding: 15px">
        <a href="{% url 'admin:session_slots_sessionslot_add' %}"
           class="button"
           style="text-align: center;
                  padding: 12px;
                  text-decoration: none">+ Create Session</a>
        <a href="{% url 'admin:bookings_booking_add' %}"
           class="button"
           style="text-align: center;
                  padding: 12px;
                  text-decoration: none">+ New Booking</a>
        <a href="{% url 'admin:karts_kart_add' %}"
           class="button"
           style="text-align: center;
                  padding: 12px;
                  text-decoration: none">+ Add Kart</a>
        <a href="{% url 'admin:bookings_booking_changelist' %}?status__exact=PENDING"
           class="button"
           style="text-align: center;
                  padding: 12px;
                  text-decoration: none">Review Pending</a>
      </div>
    </div>

    <!-- Original App List -->
    <div class="module">
      <h2>
        All Applications
      </h2>
      {% if app_list %}
        {% for app in app_list %}
          <div class="app-{{ app.app_label }} module">
            <table>
              <caption>
                <a href="{{ app.app_url }}"
                   class="section"
                   title="{% blocktranslate with name=app.name %}
                            Models in the {{ name }} application
                          {% endblocktranslate %}">{{ app.name }}</a>
              </caption>
              {% for model in app.models %}
                <tr class="model-{{ model.object_name|lower }}">
                  {% if model.admin_url %}
                    <th scope="row">
                      <a href="{{ model.admin_url }}"
                         {% if model.add_url %}
                           class="addlink"
                         {% endif %}>{{ model.name }}</a>
                    </th>
                  {% else %}
                    <th scope="row">
                      {{ model.name }}
                    </th>
                  {% endif %}

                  {% if model.add_url %}
                    <td>
                      <a href="{{ model.add_url }}" class="addlink">Add</a>
                    </td>
                  {% else %}
                    <td>
                      &nbsp;
                    </td>
                  {% endif %}

                  {% if model.admin_url %}
                    {% if model.view_only %}
                      <td>
                        <a href="{{ model.admin_url }}" class="viewlink">View</a>
                      </td>
                    {% else %}
                      <td>
                        <a href="{{ model.admin_url }}" class="changelink">Change</a>
                      </td>
                    {% endif %}
                  {% else %}
                    <td>
                      &nbsp;
                    </td>
                  {% endif %}
                </tr>
              {% endfor %}
            </table>
          </div>
        {% endfor %}
      {% else %}
        <p>
          No available applications.
        </p>
      {% endif %}
    </div>
  </div>

{% endblock %}
