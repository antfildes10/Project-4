{% extends 'base/base.html' %}

{% block title %}Browse Sessions - KartControl{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-calendar-alt"></i> Browse Racing Sessions</h1>
        <p class="lead">Find and book your next racing session at KartControl.</p>
        <hr>
    </div>
</div>

<!-- Filter Section -->
<section class="mb-4" aria-labelledby="filter-heading">
    <div class="card">
        <div class="card-header bg-light">
            <h2 id="filter-heading" class="h5 mb-0">
                <i class="fas fa-filter"></i> Filter Sessions
            </h2>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-6">
                    <label for="session_type" class="form-label">Session Type</label>
                    <select name="session_type" id="session_type" class="form-select">
                        <option value="">All Types</option>
                        <option value="OPEN_SESSION" {% if request.GET.session_type == 'OPEN_SESSION' %}selected{% endif %}>Open Session</option>
                        <option value="GRAND_PRIX" {% if request.GET.session_type == 'GRAND_PRIX' %}selected{% endif %}>Grand Prix</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="date" class="form-label">Select Date</label>
                    <input type="date" name="date" id="date" value="{{ request.GET.date }}" class="form-control">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                    <a href="{% url 'sessions:session_list' %}" class="btn btn-secondary">
                        <i class="fas fa-redo"></i> Clear Filters
                    </a>
                    {% if user.is_authenticated and user.profile.is_manager %}
                        <a href="{% url 'sessions:session_create' %}" class="btn btn-success float-end">
                            <i class="fas fa-plus"></i> Create New Session
                        </a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>
</section>

<!-- Sessions List -->
<section aria-labelledby="sessions-heading">
    <h2 id="sessions-heading" class="visually-hidden">Available Sessions</h2>
    
    {% if sessions %}
        <div class="row g-4">
            {% for session in sessions %}
            <div class="col-md-6 col-lg-4">
                <article class="card h-100">
                    <div class="card-header {% if session.session_type == 'GRAND_PRIX' %}bg-warning{% else %}bg-info text-white{% endif %}">
                        <h3 class="h5 mb-0">
                            <i class="fas fa-{% if session.session_type == 'GRAND_PRIX' %}trophy{% else %}users{% endif %}" aria-hidden="true"></i>
                            {{ session.get_session_type_display }}
                        </h3>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3">
                            <p class="mb-2">
                                <strong><i class="far fa-calendar" aria-hidden="true"></i> Date:</strong><br>
                                {{ session.start_datetime|date:"l, F j, Y" }}
                            </p>
                            <p class="mb-2">
                                <strong><i class="far fa-clock" aria-hidden="true"></i> Time:</strong><br>
                                {{ session.start_datetime|date:"g:i A" }} - {{ session.end_datetime|date:"g:i A" }}
                            </p>
                            <p class="mb-2">
                                <strong><i class="fas fa-tag" aria-hidden="true"></i> Price:</strong><br>
                                <span class="h5 text-primary mb-0">&euro;{{ session.price }}</span>
                            </p>
                            <p class="mb-2">
                                <strong><i class="fas fa-users" aria-hidden="true"></i> Availability:</strong><br>
                                <span class="{% if session.get_available_spots <= 3 %}text-danger{% elif session.get_available_spots <= 5 %}text-warning{% else %}text-success{% endif %}">
                                    {{ session.get_available_spots }} / {{ session.capacity }} spots available
                                </span>
                            </p>
                            
                            {% if session.is_full %}
                                <span class="badge bg-danger">Fully Booked</span>
                            {% elif session.is_past %}
                                <span class="badge bg-secondary">Past Session</span>
                            {% else %}
                                <span class="badge bg-success">Available</span>
                            {% endif %}
                        </div>
                        
                        <div class="mt-auto">
                            <a href="{% url 'sessions:session_detail' session.pk %}" class="btn btn-primary w-100">
                                <i class="fas fa-info-circle"></i> View Details
                            </a>
                        </div>
                    </div>
                </article>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <nav aria-label="Sessions pagination" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.session_type %}&session_type={{ request.GET.session_type }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}" aria-label="First page">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.session_type %}&session_type={{ request.GET.session_type }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}" aria-label="Previous page">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                {% endif %}

                <li class="page-item active" aria-current="page">
                    <span class="page-link">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                </li>

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.session_type %}&session_type={{ request.GET.session_type }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}" aria-label="Next page">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.session_type %}&session_type={{ request.GET.session_type }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}" aria-label="Last page">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="alert alert-info" role="status">
            <h3 class="h5"><i class="fas fa-info-circle"></i> No Sessions Found</h3>
            <p class="mb-0">
                {% if request.GET %}
                    No sessions match your current filters. Try adjusting your search criteria or clearing the filters.
                {% else %}
                    There are currently no upcoming racing sessions available. Please check back later or contact us for more information.
                {% endif %}
            </p>
            {% if user.is_authenticated and user.profile.is_manager %}
                <hr>
                <a href="{% url 'sessions:session_create' %}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Create First Session
                </a>
            {% endif %}
        </div>
    {% endif %}
</section>
{% endblock %}
